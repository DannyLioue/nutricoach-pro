generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String?   // 密码哈希
  role          Role      @default(NUTRITIONIST)
  clients       Client[]

  // AI Configuration
  aiConfigs        AIModelConfig[]
  aiKeys           UserAIKey[]
  defaultProvider  String?   // Default provider ID
  useEnvFallback   Boolean   @default(true)  // Use environment keys if no user key configured

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Client {
  id               String   @id @default(cuid())
  userId           String
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name             String
  gender           Gender
  birthDate        DateTime
  height           Float
  weight           Float
  activityLevel    ActivityLevel
  allergies        String   @default("[]") // JSON string array
  medicalHistory   String   @default("[]") // JSON string array
  healthConcerns   String   @default("[]") // JSON string array - 其他健康问题
  preferences      String?
  userRequirements String?  // 用户需求（如：减重、增肌、改善睡眠、提升精力等）
  exerciseDetails  String?  // 运动详情（器材、环境、经验等）
  phone            String?
  email            String?

  // 饮食分析相关字段
  dietAnalysis     String?  // JSON格式，汇总所有饮食照片的分析结果
  dietPreferences  String?  // JSON格式，结构化的饮食偏好
  eatingHabits     String?  // JSON格式，结构化的饮食习惯

  reports          Report[]
  recommendations  Recommendation[]
  dietPhotos       DietPhoto[]
  mealGroups       DietPhotoMealGroup[]
  consultations    Consultation[]
  planEvaluations  PlanEvaluation[]
  weeklySummaries  WeeklyDietSummary[]
  taskProgress     TaskProgress[]  // 任务进度跟踪
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model Report {
  id               String   @id @default(cuid())
  clientId         String
  client           Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  fileUrl          String
  fileName         String
  fileType         String
  extractedData    Json
  analysis         Json?
  uploadedAt       DateTime @default(now())
  recommendations  Recommendation[]
}

model Recommendation {
  id          String   @id @default(cuid())
  clientId    String
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  reportId    String?
  report      Report?  @relation(fields: [reportId], references: [id], onDelete: SetNull)
  type        RecType
  content     Json
  generatedAt DateTime @default(now())
}

enum Role {
  ADMIN
  NUTRITIONIST
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum ActivityLevel {
  SEDENTARY
  LIGHT
  MODERATE
  ACTIVE
  VERY_ACTIVE
}

enum RecType {
  DIET
  EXERCISE
  LIFESTYLE
  COMPREHENSIVE
}

// 任务状态枚举（用于断点续传）
enum TaskStatus {
  PENDING       // 待执行（已创建但未开始）
  RUNNING       // 执行中
  PAUSED        // 已暂停
  COMPLETED     // 已完成
  FAILED        // 失败
  CANCELLED     // 已取消
}

model DietPhoto {
  id               String   @id @default(cuid())
  clientId         String
  client           Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  mealGroupId      String?
  mealGroup        DietPhotoMealGroup? @relation(fields: [mealGroupId], references: [id], onDelete: Cascade)

  // 照片信息
  imageUrl         String   // Base64编码的图片数据
  uploadedAt       DateTime @default(now())
  mealType         String?  // 早餐/午餐/晚餐/加餐（可选，用户可标注）
  notes            String?  // 用户备注（可选）

  // AI分析结果
  analysis         String?  // JSON格式的分析结果
  analyzedAt       DateTime? // 分析时间

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([clientId])
  @@index([mealGroupId])
}

// 饮食照片组（多张照片组成一餐/一天）
model DietPhotoMealGroup {
  id                String   @id @default(cuid())
  clientId          String
  client            Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  photos            DietPhoto[]

  // 组信息
  name              String   // 如"早餐"、"午餐"、"晚餐"或自定义名称
  date              String   // YYYY-MM-DD格式
  mealType          String?  // 早餐/午餐/晚餐/加餐/全天

  // AI 综合分析结果
  combinedAnalysis  String?  // JSON格式的综合分析结果（包含所有照片的汇总）
  totalScore        Int?     // 综合评分（0-100）
  overallRating     String?  // 综合评级（优秀/良好/一般/需改善）

  notes             String?  // 用户备注
  textDescription   String?  // 食物文字描述（当没有照片时使用）
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([clientId])
  @@index([date])
}

// 咨询记录
model Consultation {
  id               String   @id @default(cuid())
  clientId         String
  client           Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // 基本信息
  consultationDate DateTime @default(now())
  consultationType String
  sessionNotes     String?  // 手动记录的文字笔记

  // 多媒体内容
  images           String?  // JSON格式，存储图片Base64数组
  textFiles        String?  // JSON格式，存储上传的文本文件信息（txt, md, doc, docx）

  // AI分析结果（结构化JSON）
  analysis         String?  // ConsultationAnalysis JSON
  analyzedAt       DateTime?

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([clientId])
  @@index([consultationDate])
}

// 营养师计划评估
model PlanEvaluation {
  id              String   @id @default(cuid())
  clientId        String
  client          Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // 原始计划
  planType        String   @default("diet") // diet 或 exercise
  fileName        String
  fileType        String   // txt/md/docx
  originalContent String   // 原始文本内容
  extractedData   Json?    // AI 提取的结构化数据

  // 评估结果
  evaluation      Json     // 评估结果（安全/需调整/不安全）
  concerns        Json     // 具体问题列表
  suggestions     Json     // 调整建议

  // AI 优化后的计划
  optimizedPlan   Json?    // 优化后的完整计划（结构化数据）

  // 元数据
  createdAt       DateTime @default(now())

  @@index([clientId])
  @@index([clientId, planType])
}

// 饮食汇总 (支持自定义日期范围，最多7天)
model WeeklyDietSummary {
  id               String   @id @default(cuid())
  clientId         String
  client           Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // 原有周信息字段 (保留向后兼容)
  weekStartDate    String?  // 周一日期 YYYY-MM-DD (可选，用于周汇总)
  weekEndDate      String?  // 周日日期 YYYY-MM-DD
  weekNumber       Int?     // 年内周序号 (1-52)
  year             Int?     // 年份

  // 新增：自定义日期范围字段
  startDate        String   @default("") // 汇总开始日期 YYYY-MM-DD
  endDate          String   @default("") // 汇总结束日期 YYYY-MM-DD (最多7天)

  // 新增：汇总名称和类型
  summaryName      String?  // 用户自定义的汇总名称，如"第一周汇总"、"春节假期饮食"等
  summaryType      String   @default("week") // 汇总类型: "week"(周), "custom"(自定义)

  // 关联数据
  mealGroupIds     String   // JSON数组: 包含的食谱组ID列表

  // AI分析结果 (结构化JSON)
  summary          String   // WeeklyDietSummary JSON

  // 元数据
  recommendationId String?  // 依据的推荐方案ID (引用recommendation表)
  generatedAt      DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([clientId])
  @@index([clientId, startDate])
  @@index([clientId, startDate, endDate])
  // 移除唯一约束，允许多个汇总
}

// ========================================
// AI Configuration Models
// ========================================

// AI Provider (Google, OpenAI, Anthropic, etc.)
model AIProvider {
  id          String   @id @default(cuid())
  name        String   @unique // "google", "openai", "anthropic"
  displayName String   // "Google Gemini", "OpenAI GPT"
  enabled     Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  models      AIModel[]
  userKeys    UserAIKey[]
}

// AI Model (gemini-2.5-pro, gpt-4o, etc.)
model AIModel {
  id              String      @id @default(cuid())
  providerId      String
  provider        AIProvider  @relation(fields: [providerId], references: [id], onDelete: Cascade)

  modelId         String      // "gemini-2.5-pro", "gpt-4o"
  displayName     String      // "Gemini 2.5 Pro"
  description     String?     // Optional description

  capabilities    String      // JSON: ["text", "vision", "json-mode", "function-calling"]
  maxTokens       Int?

  enabled         Boolean     @default(true)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  userConfigs     AIModelConfig[]

  @@unique([providerId, modelId])
}

// User's encrypted API key
model UserAIKey {
  id           String     @id @default(cuid())
  userId       String
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  providerId   String
  provider     AIProvider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  apiKey       String     // Encrypted API key
  keyLast4     String     // Last 4 digits for display (e.g., "sk-...xyz9")
  isValid      Boolean    @default(true)
  lastValidated DateTime?

  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@unique([userId, providerId])
  @@index([userId])
}

// Per-module model configuration
model AIModelConfig {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  modelId     String
  model       AIModel  @relation(fields: [modelId], references: [id], onDelete: Cascade)

  taskType    String   // "health-analysis", "diet-photo", etc.
  enabled     Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, modelId, taskType])
  @@index([userId])
  @@index([taskType])
}

// ========================================
// Task Progress Models (断点续传)
// ========================================

// 任务进度跟踪表
model TaskProgress {
  id               String   @id @default(cuid())

  // 任务标识
  taskType         String   // "weekly-summary", "meal-analysis", etc.
  clientId         String
  client           Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // 任务状态
  status           TaskStatus @default(PENDING)
  currentStep      String?  // 当前步骤key (auth, fetch, analyze, etc.)
  progress         Int      @default(0) // 0-100

  // 任务参数（JSON存储，支持不同任务类型的参数）
  parameters       Json     // { startDate, endDate, summaryName, summaryType, ... }

  // 已完成的步骤（JSON数组，保存已完成的步骤key列表）
  completedSteps   String   @default("[]") // JSON: ["auth", "fetch", "validate", ...]

  // 中间数据（JSON存储，保存任务的中间状态）
  intermediateData String?  // JSON: { analyzedGroupIds, recommendationId, mealGroups, ... }

  // 结果数据（任务完成后的结果）
  resultData       String?  // JSON: { summaryId, summary, ... }

  // 错误信息
  error            String?

  // 时间追踪
  startedAt        DateTime?
  completedAt      DateTime?
  pausedAt         DateTime?
  cancelledAt      DateTime?
  lastHeartbeatAt  DateTime?

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([clientId])
  @@index([clientId, taskType])
  @@index([clientId, status])
  @@index([taskType, status])
  @@index([status, updatedAt])
}
