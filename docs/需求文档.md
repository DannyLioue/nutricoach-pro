# NutriCoach Pro - 需求文档

> 专为营养师打造的 AI 驱动健康管理平台

## 1. 项目概述

### 1.1 产品定位
NutriCoach Pro 是一款面向专业营养师的智能健康管理平台，通过 AI 技术自动化健康数据分析，帮助营养师更高效地为客户提供个性化营养方案。

### 1.2 目标用户
- **主要用户**：专业营养师、健康管理师
- **最终受益者**：需要健康管理的客户

### 1.3 核心价值
- **提高效率**：AI 自动分析体检报告，节省营养师时间
- **科学决策**：基于客观数据生成个性化建议
- **专业形象**：生成可视化、专业化的健康报告
- **长期跟踪**：持续记录客户饮食和健康数据

---

## 2. 功能需求

### 2.1 用户认证与权限管理

#### 2.1.1 用户注册
| 需求项 | 描述 |
|--------|------|
| 输入项 | 用户名、邮箱、密码 |
| 验证规则 | 邮箱格式验证、密码强度要求 |
| 默认角色 | NUTRITIONIST（营养师） |

#### 2.1.2 用户登录
| 需求项 | 描述 |
|--------|------|
| 认证方式 | 邮箱 + 密码 |
| 会话管理 | 基于 JWT 的会话保持 |
| 记住状态 | 可选记住登录状态 |

#### 2.1.3 权限体系
| 角色 | 权限 |
|------|------|
| ADMIN | 系统管理、用户管理 |
| NUTRITIONIST | 客户管理、报告分析、建议生成 |

### 2.2 客户管理模块

#### 2.2.1 客户列表
| 功能 | 描述 |
|------|------|
| 列表展示 | 显示所有客户的基本信息 |
| 搜索过滤 | 按姓名搜索、按创建时间排序 |
| 快速操作 | 查看详情、编辑、删除 |
| 分页加载 | 支持大量客户数据展示 |

#### 2.2.2 创建客户
| 信息类别 | 字段 |
|----------|------|
| 基本信息 | 姓名、性别、出生日期 |
| 身体数据 | 身高、体重、活动水平 |
| 健康信息 | 过敏原、疾病史、健康问题 |
| 偏好设置 | 饮食偏好、用户需求 |
| 联系方式 | 电话、邮箱（可选） |

**活动水平选项**：
- 久坐（几乎不运动）
- 轻度（每周1-3次轻度运动）
- 中度（每周3-5次中等运动）
- 活跃（每周6-7次运动）
- 非常活跃（每天运动/体力工作）

#### 2.2.3 编辑客户
| 功能 | 描述 |
|------|------|
| 信息修改 | 支持修改所有客户字段 |
| 数据验证 | 保持数据完整性和一致性 |
| 历史记录 | 保留更新历史（可选） |

#### 2.2.4 客户详情页
| 模块 | 内容 |
|------|------|
| **基本信息** | 性别、年龄、BMI、BMI分类 |
| **身体数据** | 身高、体重、活动水平 |
| **健康信息** | 过敏原标签、疾病史标签、健康问题标签 |
| **饮食偏好** | 客户填写的饮食偏好 |
| **联系方式** | 电话、邮箱 |

**BMI 分类标准**：
| 范围 | 分类 | 颜色标识 |
|------|------|----------|
| < 18.5 | 偏瘦 | 蓝色 |
| 18.5 - 24 | 正常 | 绿色 |
| 24 - 28 | 超重 | 黄色 |
| > 28 | 肥胖 | 红色 |

### 2.3 体检报告分析模块

#### 2.3.1 报告上传
| 功能 | 描述 |
|------|------|
| 支持格式 | PDF 文件、图片（JPG、PNG） |
| 上传方式 | 拖拽上传或点击选择 |
| 文件大小限制 | 单文件最大 10MB |
| 批量上传 | 支持多文件同时上传 |

#### 2.3.2 AI 报告分析
**分析能力**：
- 从 PDF/图片中提取健康指标数据
- 自动识别指标名称、检测值、单位、正常范围
- 判断指标是否异常（偏高/偏低/正常）
- 评估健康风险等级（高/中/低）
- 计算综合健康评分（0-100）

**分析输出**：
```json
{
  "summary": "整体健康状况总结",
  "bmi": 23.5,
  "bmiCategory": "正常",
  "abnormalIndicators": [
    {
      "indicator": "空腹血糖",
      "value": "6.8",
      "normalRange": "3.9-6.1",
      "status": "偏高",
      "risk": "糖尿病前期风险",
      "priority": "高"
    }
  ],
  "nutrientDeficiencies": ["维生素D", "钙"],
  "riskFactors": ["胰岛素抵抗", "心血管疾病风险"],
  "overallHealthScore": 72
}
```

#### 2.3.3 报告详情展示
| 展示区域 | 内容 |
|----------|------|
| 报告信息 | 文件名、上传时间、报告类型 |
| 健康评分 | 综合评分卡片、等级分类 |
| 异常指标 | 异常指标列表（按优先级排序） |
| 营养缺乏 | 缺乏的营养素列表 |
| 风险因素 | 健康风险提示 |

### 2.4 咨询记录模块

#### 2.4.1 咨询记录列表
| 功能 | 描述 |
|------|------|
| 列表展示 | 显示客户的所有咨询记录 |
| 排序方式 | 按咨询日期倒序排列 |
| 快速操作 | 查看详情、删除记录 |
| 信息摘要 | 日期、类型、音频数量、图片数量、分析状态 |

#### 2.4.2 创建咨询记录
| 信息类别 | 字段 | 说明 |
|----------|------|------|
| 基本信息 | 咨询日期 | 默认当天 |
| | 咨询类型 | 初次咨询、随访咨询、电话咨询等 |
| | 咨询笔记 | 手动记录的文字内容 |
| 多媒体 | 音频上传 | 支持上传 MP3 等音频文件 |
| | 图片上传 | 支持上传相关图片 |

**音频文件处理**：
- 支持格式：MP3、M4A、WAV 等
- 文件大小限制：单文件最大 20MB
- 批量上传：支持上传多个音频文件
- 自动转录：上传后自动调用 AI 进行语音转文字
- 说话人识别：自动区分营养师和客户的发言
- 转录状态：pending → transcribing → completed / failed
- 失败重试：转录失败时可重新转录

#### 2.4.3 AI 咨询分析
| 分析内容 | 说明 |
|----------|------|
| 总结 | 整体咨询内容摘要 |
| 饮食变化 | 客户饮食依从性评估、报告的变化 |
| 行动建议 | 针对下次咨询的行动计划 |
| 优先级 | 建议的优先级（高/中/低） |

**分析输出**：
```json
{
  "summary": "本次咨询中客户反馈血糖控制良好，饮食习惯有所改善",
  "dietChanges": {
    "complianceLevel": "high",
    "reportedChanges": [
      "减少了米饭摄入量",
      "增加了蔬菜摄入",
      "戒掉了含糖饮料"
    ]
  },
  "nutritionistActionItems": {
    "priority": "medium",
    "followUpActions": [
      "继续监测血糖变化",
      "下周增加蛋白质摄入",
      "记录饮食照片"
    ]
  }
}
```

#### 2.4.4 咨询详情展示
| 展示区域 | 内容 |
|----------|------|
| 基本信息 | 日期、类型、咨询笔记 |
| AI 分析 | 分析结果卡片（如已分析） |
| 音频文件 | 播放器、转录状态、转录文本 |
| 结构化对话 | 按说话人分类的对话内容 |
| 图片 | 缩略图网格展示 |

**转录文本展示**：
- 结构化对话：区分营养师和客户的发言
- 原始转录：完整的转录文本
- 可折叠：点击展开/收起转录内容
- 实时刷新：自动更新转录状态（无页面闪烁）

### 2.5 饮食照片分析模块

#### 2.5.1 照片上传
| 功能 | 描述 |
|------|------|
| 拖拽上传 | 支持拖拽图片到上传区域 |
| 批量上传 | 一次最多上传 9 张照片 |
| 图片格式 | JPG、PNG |
| 图片大小 | 单张最大 5MB |
| Base64 存储 | 图片以 Base64 格式存储 |

#### 2.5.2 照片信息标注
| 字段 | 描述 | 是否必填 |
|------|------|----------|
| 餐型 | 早餐/午餐/晚餐/加餐 | 否 |
| 备注 | 用户自定义备注 | 否 |

#### 2.5.3 AI 照片分析
**分析能力**：
- 识别照片中的所有食物
- 判断食物类别和分量
- 评估营养均衡状况
- 识别饮食问题
- 提供改进建议
- 给出综合评分

**分析输出**：
```json
{
  "mealType": "午餐",
  "description": "米饭配青菜和红烧肉",
  "foods": [
    {
      "name": "米饭",
      "category": "主食",
      "portion": "中",
      "cookingMethod": "蒸"
    }
  ],
  "nutritionBalance": {
    "protein": "充足",
    "vegetables": "不足",
    "carbs": "精制",
    "fat": "混合",
    "fiber": "不足"
  },
  "issues": [
    {
      "type": "缺乏蔬菜",
      "severity": "中",
      "description": "蔬菜摄入量偏少"
    }
  ],
  "suggestions": [
    {
      "category": "增加",
      "content": "增加一份蔬菜"
    }
  ],
  "overallScore": 75,
  "overallRating": "良好"
}
```

#### 2.5.4 照片卡片展示
| 展示内容 | 描述 |
|----------|------|
| 图片预览 | 显示原始图片 |
| 上传信息 | 上传时间、餐型、备注 |
| 分析结果 | 评分、等级、营养均衡、食物清单 |
| 操作按钮 | 分析按钮、删除按钮 |

#### 2.5.5 饮食偏好汇总
| 功能 | 描述 |
|------|------|
| 综合评分 | 所有照片的平均分 |
| 常吃食物 | 出现频率高的食物 |
| 烹饪方式 | 常用的烹饪方法 |
| 用餐模式 | 餐型分布 |
| 饮食问题 | 高频出现的问题 |
| 饮食优点 | 做得好的方面 |
| 改进建议 | 针对性建议 |

### 2.6 营养建议生成模块

#### 2.6.1 建议类型
| 类型 | 说明 |
|------|------|
| 饮食建议 (DIET) | 个性化饮食方案 |
| 运动建议 (EXERCISE) | 运动处方 |
| 生活方式建议 (LIFESTYLE) | 生活习惯指导 |
| 综合建议 (COMPREHENSIVE) | 包含以上所有内容 |

#### 2.6.2 饮食建议内容
| 类别 | 内容 |
|------|------|
| 热量目标 | 每日总热量需求 |
| 宏量营养素 | 蛋白质、碳水、脂肪目标 |
| 推荐食物 | 针对健康问题的食物清单 |
| 避免食物 | 需要限制的食物清单 |
| 补充剂 | 建议的营养补充剂 |
| 食谱计划 | 早、中、晚餐和加餐建议 |

#### 2.6.3 运动建议内容
| 类别 | 内容 |
|------|------|
| 每周目标 | 运动频率和时长要求 |
| 运动方案 | 具体运动类型、强度、频率 |
| 注意事项 | 根据健康状况的提醒 |

#### 2.6.4 生活方式建议内容
| 类别 | 内容 |
|------|------|
| 睡眠建议 | 睡眠时长和习惯 |
| 饮水建议 | 每日饮水量 |
| 压力管理 | 减压方法建议 |

### 2.7 报告导出模块

#### 2.7.1 PDF 导出
| 功能 | 描述 |
|------|------|
| 分析报告 | 体检报告分析结果 PDF |
| 建议报告 | 营养建议方案 PDF |
| 综合报告 | 包含分析和建议的完整报告 |
| 格式化输出 | 专业的排版和格式 |

---

## 3. 非功能需求

### 3.1 性能要求
| 指标 | 要求 |
|------|------|
| 页面加载时间 | < 2 秒 |
| API 响应时间 | < 3 秒 |
| AI 分析响应 | < 30 秒 |
| 并发用户数 | 支持 50+ 同时在线 |

### 3.2 安全要求
| 项目 | 要求 |
|------|------|
| 密码加密 | bcrypt 加密存储 |
| 会话管理 | JWT token 认证 |
| 数据隔离 | 用户数据完全隔离 |
| API 鉴权 | 所有 API 需要认证 |

### 3.3 可用性要求
| 项目 | 要求 |
|------|------|
| 浏览器支持 | Chrome、Firefox、Safari、Edge |
| 响应式设计 | 支持桌面端和平板 |
| 深色模式 | 支持深色主题 |
| 移动端 | 优先桌面端，兼容平板 |

### 3.4 可维护性要求
| 项目 | 要求 |
|------|------|
| 代码规范 | TypeScript + ESLint |
| 注释文档 | 关键功能需要注释 |
| 测试覆盖 | 核心功能单元测试 |
| 版本控制 | Git 版本管理 |

---

## 4. 用户界面设计

### 4.1 整体布局
```
┌─────────────────────────────────────────────────────────┐
│                    顶部导航栏                            │
│  [Logo] [仪表盘] [客户] [分析] [建议] [设置] [用户]      │
├─────────────────────────────────────────────────────────┤
│                                                         │
│                   主内容区域                             │
│                                                         │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 4.2 颜色系统
| 用途 | 颜色 | 说明 |
|------|------|------|
| 主色调 | Emerald (绿色) | 健康、自然 |
| 成功 | Green | 正常指标 |
| 警告 | Yellow | 需注意 |
| 危险 | Red | 异常指标 |
| 信息 | Blue | 提示信息 |

### 4.3 组件规范
| 组件 | 样式 | 交互 |
|------|------|------|
| 按钮 | 圆角、阴影 | Hover 变色 |
| 卡片 | 白色背景、边框 | Hover 上浮 |
| 表单 | 清晰标签 | 实时验证 |
| 标签 | 彩色背景 | 可点击关闭 |

---

## 5. 业务流程

### 5.1 客户管理流程
```
注册/登录 → 进入客户列表 → 创建客户 → 填写客户信息 → 保存 → 客户详情
```

### 5.2 体检报告分析流程
```
选择客户 → 上传体检报告 → AI 分析 → 查看分析结果 → 生成建议 → 导出 PDF
```

### 5.3 咨询记录流程
```
进入客户详情 → 咨询记录标签 → 创建咨询 → 填写基本信息 → 上传音频/图片 →
自动转录音频 → 查看转录内容 → AI 分析咨询 → 导出报告
```

### 5.4 饮食照片分析流程
```
进入客户详情 → 饮食照片标签 → 上传照片 → AI 分析 → 查看结果 → 汇总分析
```

### 5.5 建议生成流程
```
选择客户 → 选择报告/照片 → 选择建议类型 → AI 生成 → 查看建议 → 导出 PDF
```

---

## 6. 数据模型

### 6.1 用户 (User)
| 字段 | 类型 | 说明 |
|------|------|------|
| id | String | 唯一标识 |
| email | String | 邮箱（唯一） |
| name | String | 用户名 |
| password | String | 密码哈希 |
| role | Enum | ADMIN/NUTRITIONIST |

### 6.2 客户 (Client)
| 字段 | 类型 | 说明 |
|------|------|------|
| id | String | 唯一标识 |
| userId | String | 所属营养师 |
| name | String | 客户姓名 |
| gender | Enum | MALE/FEMALE/OTHER |
| birthDate | DateTime | 出生日期 |
| height | Float | 身高 |
| weight | Float | 体重 |
| activityLevel | Enum | 活动水平 |
| allergies | String | 过敏原 JSON 数组 |
| medicalHistory | String | 疾病史 JSON 数组 |
| healthConcerns | String | 健康问题 JSON 数组 |
| preferences | String | 饮食偏好 |
| userRequirements | String | 用户需求 |

### 6.3 体检报告 (Report)
| 字段 | 类型 | 说明 |
|------|------|------|
| id | String | 唯一标识 |
| clientId | String | 所属客户 |
| fileUrl | String | 文件存储路径 |
| fileName | String | 文件名 |
| fileType | String | 文件类型 |
| extractedData | Json | 提取的数据 |
| analysis | Json | AI 分析结果 |

### 6.4 咨询记录 (Consultation)
| 字段 | 类型 | 说明 |
|------|------|------|
| id | String | 唯一标识 |
| clientId | String | 所属客户 |
| consultationDate | DateTime | 咨询日期 |
| consultationType | String | 咨询类型 |
| sessionNotes | String? | 咨询笔记 |
| audioFiles | String? | 音频文件 JSON 数组 |
| images | String? | 图片 JSON 数组 |
| analysis | String? | AI 分析结果 JSON |
| analyzedAt | DateTime? | 分析时间 |

**AudioFile 结构**：
```typescript
{
  id: string;
  audioUrl: string;      // Base64
  fileName: string;
  fileSize: number;
  transcript?: string;   // 原始转录文本
  structuredTranscript?: {
    speaker: 'nutritionist' | 'client';
    text: string;
  }[];                   // 结构化对话
  transcriptionStatus: 'pending' | 'transcribing' | 'completed' | 'failed';
  uploadedAt: Date;
}
```

### 6.5 营养建议 (Recommendation)
| 字段 | 类型 | 说明 |
|------|------|------|
| id | String | 唯一标识 |
| clientId | String | 所属客户 |
| reportId | String | 关联报告 |
| type | Enum | DIET/EXERCISE/LIFESTYLE/COMPREHENSIVE |
| content | Json | 建议内容 |
| generatedAt | DateTime | 生成时间 |

### 6.6 饮食照片 (DietPhoto)
| 字段 | 类型 | 说明 |
|------|------|------|
| id | String | 唯一标识 |
| clientId | String | 所属客户 |
| imageUrl | String | Base64 图片 |
| mealType | String | 餐型 |
| notes | String | 备注 |
| analysis | String | AI 分析结果 JSON |
| analyzedAt | DateTime | 分析时间 |

---

## 7. API 接口需求

### 7.1 认证接口
- POST `/api/auth/register` - 用户注册
- GET `/api/auth/session` - 获取会话信息

### 7.2 客户接口
- GET `/api/clients` - 获取客户列表
- POST `/api/clients` - 创建客户
- GET `/api/clients/[id]` - 获取客户详情
- PUT `/api/clients/[id]` - 更新客户信息
- DELETE `/api/clients/[id]` - 删除客户

### 7.3 体检报告接口
- GET `/api/reports` - 获取报告列表
- POST `/api/reports` - 创建报告
- POST `/api/reports/upload` - 上传并分析报告
- GET `/api/reports/[id]` - 获取报告详情
- DELETE `/api/reports/[id]` - 删除报告

### 7.4 咨询记录接口
- GET `/api/clients/[id]/consultations` - 获取咨询记录列表
- POST `/api/clients/[id]/consultations` - 创建咨询记录
- GET `/api/clients/[id]/consultations/[consultationId]` - 获取咨询详情
- DELETE `/api/clients/[id]/consultations/[consultationId]` - 删除咨询记录
- POST `/api/clients/[id]/consultations/[consultationId]/analyze` - AI 分析咨询
- POST `/api/clients/[id]/consultations/[consultationId]/audio/[audioId]/retranscribe` - 重新转录音频

### 7.5 饮食照片接口
- GET `/api/clients/[id]/diet-photos` - 获取照片列表
- POST `/api/clients/[id]/diet-photos` - 上传照片
- DELETE `/api/clients/[id]/diet-photos/[photoId]` - 删除照片
- POST `/api/clients/[id]/diet-photos/[photoId]/analyze` - 分析照片
- GET `/api/clients/[id]/diet-analysis` - 获取饮食汇总

### 7.6 建议接口
- GET `/api/recommendations` - 获取建议列表
- POST `/api/recommendations` - 创建建议
- POST `/api/recommendations/generate` - 生成建议
- GET `/api/recommendations/[id]` - 获取建议详情

---

## 8. 测试需求

### 8.1 单元测试
| 测试范围 | 覆盖率目标 |
|----------|-----------|
| API 路由 | 80%+ |
| 核心组件 | 70%+ |
| 工具函数 | 90%+ |

### 8.2 集成测试
| 测试场景 | 要求 |
|----------|------|
| 用户认证流程 | 完整测试 |
| 客户管理流程 | 完整测试 |
| AI 分析流程 | Mock 测试 |
| 数据导出流程 | 完整测试 |

### 8.3 用户验收测试
| 测试项目 | 验收标准 |
|----------|----------|
| 核心功能可用 | 100% 通过 |
| UI 响应正常 | 无明显延迟 |
| 数据准确性 | AI 分析准确率 > 85% |

---

## 9. 部署需求

### 9.1 环境要求
| 项目 | 要求 |
|------|------|
| Node.js | >= 18.17.0 |
| 数据库 | SQLite (开发) / PostgreSQL (生产) |
| 内存 | >= 2GB |
| 存储 | >= 10GB |

### 9.2 环境变量
| 变量名 | 说明 | 必填 |
|--------|------|------|
| DATABASE_URL | 数据库连接字符串 | 是 |
| NEXTAUTH_SECRET | NextAuth 密钥 | 是 |
| NEXTAUTH_URL | 应用 URL | 是 |
| GEMINI_API_KEY | Google AI API 密钥 | 是 |

### 9.3 部署方式
- **开发环境**：本地 Next.js 开发服务器
- **生产环境**：Vercel / 自托管 Node.js 服务器

---

## 10. 项目里程碑

### 阶段一：基础功能 ✅
- [x] 用户认证系统
- [x] 客户管理模块
- [x] 基础 UI 框架

### 阶段二：体检报告分析 ✅
- [x] 报告上传功能
- [x] AI 报告分析
- [x] 分析结果展示
- [x] PDF 导出

### 阶段三：营养建议生成 ✅
- [x] 饮食建议生成
- [x] 运动建议生成
- [x] 生活方式建议
- [x] 综合建议

### 阶段四：咨询记录管理 ✅
- [x] 咨询记录创建和展示
- [x] 音频上传和播放
- [x] AI 音频转录（Gemini 2.5 Flash）
- [x] 说话人识别（营养师/客户）
- [x] 转录失败重试机制
- [x] AI 咨询内容分析
- [x] 实时状态更新（无闪烁）

### 阶段五：饮食照片分析 ✅
- [x] 照片上传
- [x] AI 照片分析
- [x] 饮食偏好汇总
- [x] 单元测试

### 阶段六：优化完善 🚧
- [ ] 性能优化
- [ ] 用户体验优化
- [ ] 数据统计分析
- [ ] 移动端适配

---

## 11. 风险与限制

### 11.1 技术风险
| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| AI API 限流 | 分析失败 | 实现重试机制、队列系统 |
| Base64 存储 | 数据库膨胀 | 考虑对象存储方案 |
| PDF 解析失败 | 分析不准确 | 多种解析方案备选 |

### 11.2 业务限制
| 限制 | 说明 |
|------|------|
| AI 准确性 | AI 分析结果仅供参考 |
| 数据安全 | 需遵守医疗数据隐私法规 |
| 单用户系统 | 目前不支持多营养师协作 |

---

## 12. 未来规划

### 12.1 短期计划（3个月）
- [ ] 添加数据统计和图表
- [ ] 客户进度跟踪功能
- [ ] 批量导入客户数据
- [ ] 移动端响应式优化

### 12.2 中期计划（6个月）
- [ ] 多营养师协作功能
- [ ] 客户自助查看报告
- [ ] 微信小程序版本
- [ ] 数据备份与恢复

### 12.3 长期计划（1年+）
- [ ] iOS/Android 原生应用
- [ ] 智能穿戴设备数据集成
- [ ] 机器学习个性化推荐
- [ ] SaaS 多租户版本
