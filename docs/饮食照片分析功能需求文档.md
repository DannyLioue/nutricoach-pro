# 饮食照片上传与分析功能需求文档

## 1. 功能概述

### 1.1 功能目标
为营养师客户提供饮食照片上传和AI分析功能，帮助营养师更准确地了解客户的：
- 实际饮食偏好（喜欢的食物类型）
- 饮食习惯（进餐时间、分量大小、烹饪方式）
- 潜在问题（高油高盐、营养不均衡、缺乏蔬菜等）

### 1.2 核心价值
- **可视化分析**：通过照片直观了解客户真实饮食情况
- **数据驱动**：AI分析结果补充客户自述信息
- **个性化方案**：基于实际饮食生成更精准的营养建议

---

## 2. 现有功能分析

### 2.1 客户数据模型（Prisma Schema）

当前 `Client` 模型包含：
```prisma
model Client {
  id               String   @id @default(cuid())
  userId           String
  name             String
  gender           Gender
  birthDate        DateTime
  height           Float
  weight           Float
  activityLevel    ActivityLevel
  allergies        String   @default("[]")
  medicalHistory   String   @default("[]")
  healthConcerns   String   @default("[]")
  preferences      String?  // 饮食偏好（文本字段）
  userRequirements String?  // 用户需求
  phone            String?
  email            String?
  reports          Report[]
  recommendations  Recommendation[]
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}
```

**现有问题**：
- `preferences` 只是简单的文本字段，无法结构化存储饮食分析结果
- 没有存储饮食照片的机制
- 没有AI分析的饮食偏好数据

### 2.2 现有上传功能

系统已有**体检报告上传**功能：
- **位置**：分析页面 (`/analysis/new`)
- **支持格式**：图片、PDF
- **存储方式**：Base64编码存入数据库
- **AI分析**：使用 Google Gemini AI 提取健康指标

**可复用部分**：
- 文件上传组件
- Base64编码存储逻辑
- AI分析API调用模式

---

## 3. 新功能设计

### 3.1 数据库设计

#### 3.1.1 新增 `DietPhoto` 模型

```prisma
model DietPhoto {
  id               String   @id @default(cuid())
  clientId         String
  client           Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // 照片信息
  imageUrl         String   // Base64编码的图片数据
  uploadedAt       DateTime @default(now())
  mealType         String?  // 早餐/午餐/晚餐/加餐（可选，用户可标注）
  notes            String?  // 用户备注（可选）

  // AI分析结果
  analysis         String?  // JSON格式的分析结果
  analyzedAt       DateTime? // 分析时间

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([clientId])
}
```

#### 3.1.2 扩展 `Client` 模型

```prisma
model Client {
  // ... 现有字段 ...

  // 新增：饮食分析汇总字段
  dietAnalysis     String?  // JSON格式，汇总所有饮食照片的分析结果
  dietPreferences   String?  // JSON格式，结构化的饮食偏好
  eatingHabits      String?  // JSON格式，结构化的饮食习惯

  // 新增关联
  dietPhotos       DietPhoto[] // 关联的饮食照片
}
```

### 3.2 AI分析输出结构

```typescript
interface DietAnalysis {
  // 基本信息
  mealType: string;        // 识别的餐型（早餐/午餐/晚餐/加餐）
  description: string;      // 照片描述

  // 食物识别
  foods: Array<{
    name: string;          // 食物名称
    category: string;       // 食物类别（主食/蔬菜/肉类/汤类等）
    portion: string;        // 分量描述（大/中/小）
    cookingMethod: string;  // 烹饪方式（炒/蒸/煮/炸等）
  }>;

  // 营养分析
  nutritionBalance: {
    protein: string;        // 蛋白质来源（充足/不足）
    vegetables: string;     // 蔬菜摄入量
    carbs: string;          // 碳水化合物类型
    fat: string;            // 脂肪来源（动物/植物）
    fiber: string;          // 膳食纤维摄入
  };

  // 问题识别
  issues: Array<{
    type: string;           // 问题类型（高盐/高油/缺乏蔬菜/精制碳水等）
    severity: string;        // 严重程度（高/中/低）
    description: string;     // 问题描述
  }>;

  // 改进建议
  suggestions: Array<{
    category: string;       // 建议类别（增加/减少/替换）
    content: string;        // 建议内容
  }>;

  // 综合评分
  overallScore: number;     // 综合评分（0-100）
  overallRating: string;    // 综合评级（优秀/良好/一般/需改善）
}
```

### 3.3 UI页面设计

#### 3.3.1 客户详情页面增强

在现有客户列表中，点击客户姓名后，应该能看到：

**新增"饮食照片"标签页**（在"基本信息"之后）：

```
[客户详情页面布局]
┌─────────────────────────────────────────────────────────┐
│ 客户名称 - 详情                                       │
├─────────────────────────────────────────────────────────┤
│ [基本信息] [饮食照片] [体检报告] [营养建议]            │
├─────────────────────────────────────────────────────────┤
│                                                         │
│ 【饮食照片分析】标签页内容：                            │
│                                                         │
│ ┌─────────────────────────────────────────────────────┐ │
│ │ 上传照片区域                                         │ │
│ │ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐  │ │
│ │ │   拖拽上传   │ │   拖拽上传   │ │   拖拽上传   │  │ │
│ │ │    或点击    │ │    或点击    │ │    或点击    │  │ │
│ │ └─────────────┘ └─────────────┘ └─────────────┘  │ │
│ │                                                     │ │
│ │ 支持同时上传多张照片（最多9张）                    │ │
│ │ 格式：JPG, PNG，每张不超过5MB                      │ │
│ └─────────────────────────────────────────────────────┘ │
│                                                         │
│ 【已上传照片】（卡片网格布局）                          │
│ ┌─────────────────────────────────────────────────┐   │
│ │ 2024-01-15 早餐                      [分析] [删除]│   │
│ │ ┌─────────────────────────────────────────────┐ │   │
│ │ │ [照片缩略图]                                │ │   │
│ │ │ ┌─────────────────────────────────────────┐ │ │   │
│ │ │ │ 综合评分: 85分（良好）                  │ │ │   │
│ │ │ │ ✅ 蔬菜充足  ⚠️ 蛋白质略少  ❌ 油脂过高  │ │ │   │
│ │ │ └─────────────────────────────────────────┘ │ │   │
│ │ └─────────────────────────────────────────────┘ │   │
│ └─────────────────────────────────────────────────┘   │
│ ┌─────────────────────────────────────────────────┐   │
│ │ 2024-01-14 午餐                                     │   │
│ │ [照片缩略图] [分析中...]                          │   │
│ └─────────────────────────────────────────────────┘   │
│                                                         │
│ 【饮食偏好汇总】（基于所有照片分析）                  │
│ ┌─────────────────────────────────────────────────┐   │
│ │ • 偏好的食物类型：米饭、面条、炒青菜              │   │
│ │ • 经常摄入：猪肉、鸡肉、叶菜类                    │   │
│ │ • 缺乏食物：鱼类、奶制品、水果                     │   │
│ │ • 烹饪方式偏好：炒、蒸                            │   │
│ │ • 潜在问题：油脂偏多、蔬菜分量不足                │   │
│ └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

#### 3.3.2 编辑客户页面增强

在现有编辑页面底部增加：

```
【饮食照片管理】部分（在"联系信息"之后）：

┌─────────────────────────────────────────────────────┐
│ 饮食照片管理                                        │
├─────────────────────────────────────────────────────┤
│                                                     │
│ [点击上传按钮]                                      │
│                                                     │
│ 已上传的照片：                                       │
│ ┌────┐ ┌────┐ ┌────┐                                │
│ │图1 │ │图2 │ │图3 │ [+ 添加更多]                 │
│ └────┘ └────┘ └────┘                                │
│                                                     │
│ 提示：上传后系统会自动分析饮食偏好和习惯             │
└─────────────────────────────────────────────────────┘
```

### 3.4 API设计

#### 3.4.1 上传饮食照片 API

**端点**：`POST /api/clients/[clientId]/diet-photos`

**请求**：
```typescript
{
  photos: Array<{
    data: string;      // Base64图片数据
    mealType?: string;  // 餐型（可选）
    notes?: string;    // 备注（可选）
  }>;
}
```

**响应**：
```typescript
{
  success: boolean;
  message: string;
  photos: Array<{
    id: string;
    imageUrl: string;
    uploadedAt: string;
  }>;
}
```

#### 3.4.2 获取客户饮食照片 API

**端点**：`GET /api/clients/[clientId]/diet-photos`

**响应**：
```typescript
{
  photos: Array<{
    id: string;
    imageUrl: string;
    mealType: string | null;
    notes: string | null;
    analysis: DietAnalysis | null;
    uploadedAt: string;
    analyzedAt: string | null;
  }>;
}
```

#### 3.4.3 分析饮食照片 API

**端点**：`POST /api/clients/[clientId]/diet-photos/[photoId]/analyze`

**响应**：
```typescript
{
  success: boolean;
  analysis: DietAnalysis;
  analyzedAt: string;
}
```

#### 3.4.4 删除饮食照片 API

**端点**：`DELETE /api/clients/[clientId]/diet-photos/[photoId]`

**响应**：
```typescript
{
  success: boolean;
  message: string;
}
```

#### 3.4.5 获取饮食分析汇总 API

**端点**：`GET /api/clients/[clientId]/diet-analysis`

**响应**：
```typescript
{
  summary: {
    totalPhotos: number;
    analyzedPhotos: number;
    overallScore: number;
  };
  preferences: {
    preferredFoods: string[];
    avoidedFoods: string[];
    cookingMethods: string[];
    mealPatterns: string[];
  };
  habits: {
    issues: string[];
    strengths: string[];
    recommendations: string[];
  };
}
```

### 3.5 AI提示词设计

#### 分析饮食照片的AI提示词结构

```typescript
const DIET_ANALYSIS_PROMPT = `
你是一位专业的营养师，请分析这张饮食照片并提供详细的营养评估。

## 分析要求

1. **食物识别**：
   - 识别照片中的所有食物
   - 判断食物类别（主食、蔬菜、肉类、汤类、水果等）
   - 估算分量大小

2. **营养均衡评估**：
   - 蛋白质来源是否充足
   - 蔬菜摄入量是否足够
   - 碳水化合物类型（精制/全谷物）
   - 脂肪来源（动物性/植物性）
   - 膳食纤维摄入情况

3. **问题识别**：
   - 高油高盐问题
   - 营养不均衡
   - 缺乏某些营养素
   - 加工食品过多
   - 烹饪方式不健康

4. **改进建议**：
   - 具体的增加/减少/替换建议
   - 量化建议（如"增加一份蔬菜"）
   - 可操作的改进方案

5. **综合评分**：
   - 0-100分评分
   - 综合评级（优秀/良好/一般/需改善）

## 输出格式

请以JSON格式输出分析结果，包含以下字段：
{
  "mealType": "识别的餐型",
  "description": "照片简要描述",
  "foods": [...],
  "nutritionBalance": {...},
  "issues": [...],
  "suggestions": [...],
  "overallScore": 85,
  "overallRating": "良好"
}

## 客户背景信息

客户信息：
- 姓名：${client.name}
- 健康问题：${client.healthConcerns}
- 饮食偏好：${client.preferences || '无特殊偏好'}
- 用户需求：${client.userRequirements || '无特殊需求'}

请结合客户的健康状况和需求，提供针对性的分析和建议。
`;
```

---

## 4. 开发任务清单

### 阶段1：数据库和后端API

- [ ] 更新 Prisma Schema，添加 `DietPhoto` 模型
- [ ] 扩展 `Client` 模型，添加饮食分析相关字段
- [ ] 运行数据库迁移
- [ ] 创建饮食照片上传 API (`/api/clients/[clientId]/diet-photos`)
- [ ] 创建获取饮食照片 API (`/api/clients/[clientId]/diet-photos`)
- [ ] 创建分析饮食照片 API (`/api/clients/[clientId]/diet-photos/[photoId]/analyze`)
- [ ] 创建删除饮食照片 API (`/api/clients/[clientId]/diet-photos/[photoId]`)
- [ ] 创建获取饮食分析汇总 API (`/api/clients/[clientId]/diet-analysis`)

### 阶段2：前端UI组件

- [ ] 创建照片上传组件（支持多图上传）
- [ ] 创建照片卡片展示组件（显示缩略图+分析结果）
- [ ] 创建饮食分析结果展示组件
- [ ] 创建饮食偏好汇总展示组件
- [ ] 在客户详情页面添加"饮食照片"标签页
- [ ] 在编辑客户页面添加饮食照片上传区域

### 阶段3：AI分析逻辑

- [ ] 实现饮食照片AI分析逻辑
- [ ] 实现多照片分析汇总逻辑
- [ ] 优化AI提示词以适应不同健康状况的客户
- [ ] 添加分析结果缓存机制

### 阶段4：集成和优化

- [ ] 将饮食分析结果整合到营养建议生成中
- [ ] 添加照片管理权限控制
- [ ] 优化图片压缩和加载性能
- [ ] 添加错误处理和用户提示
- [ ] 编写单元测试和集成测试

---

## 5. 技术实现要点

### 5.1 图片存储方案

**采用Base64编码存储**（与体检报告相同）：
- 优点：简单、无需额外存储服务
- 缺点：数据库体积增大
- 缓解：限制单张图片大小（最大5MB），建议上传前压缩

**未来扩展**：可考虑使用云存储（OSS、S3等）存储图片URL

### 5.2 AI分析时机

**方案1：上传时立即分析**
- 优点：用户体验好，立即看到结果
- 缺点：上传速度慢，批量上传耗时长

**方案2：手动触发分析**
- 优点：上传快速，用户可控
- 缺点：需要额外操作

**推荐**：采用方案1，但显示分析进度

### 5.3 数据一致性

- 删除客户时级联删除相关饮食照片
- 分析失败不影响照片存储
- 支持重新分析已上传的照片

### 5.4 性能优化

- 图片懒加载
- 使用WebP格式压缩
- 分析结果缓存
- 批量分析队列处理

---

## 6. 用户使用流程

### 6.1 上传饮食照片流程

```
1. 用户进入客户详情页面
2. 点击"饮食照片"标签页
3. 点击上传区域或拖拽照片
4. 可选择标注餐型（早餐/午餐/晚餐/加餐）
5. 可添加备注说明
6. 上传后自动触发AI分析
7. 显示分析结果
```

### 6.2 查看分析结果流程

```
1. 在"饮食照片"标签页查看已上传照片
2. 点击照片卡片查看详细分析
3. 查看"饮食偏好汇总"了解综合分析
4. 基于分析结果调整营养方案
```

---

## 7. 成功指标

### 7.1 功能指标
- 支持单次上传最多9张照片
- AI分析准确率达到80%以上
- 分析响应时间 < 10秒
- 图片上传成功率 > 95%

### 7.2 用户体验指标
- 上传流程简单直观（最多3步完成）
- 分析结果清晰易懂
- 移动端适配良好
- 错误提示友好明确

---

## 8. 后续优化方向

### 8.1 短期优化（1-2周后）
- 添加照片批量上传功能
- 支持照片分类筛选（按餐型、按日期）
- 添加饮食趋势图表展示
- 导出饮食分析报告PDF

### 8.2 中期优化（1-2月后）
- AI识别准确度优化（训练定制模型）
- 支持视频分析
- 添加营养师手动标注功能
- 生成个性化饮食建议

### 8.3 长期优化（3-6月后）
- 饮食记录追踪功能
- 前后对比分析
- 与智能厨房设备集成
- 社区分享功能

---

**文档版本**：v1.0
**创建日期**：2025-01-25
**最后更新**：2025-01-25
