# NutriCoach Pro - 技术文档

> 完整的技术架构、开发指南和 API 文档

## 1. 技术栈

### 1.1 核心技术
| 技术 | 版本 | 用途 |
|------|------|------|
| Next.js | 16.1.1 | React 框架，App Router |
| TypeScript | 5.x | 类型安全 |
| Tailwind CSS | 4.x | 样式框架 |
| Prisma | 6.19.1 | ORM 框架 |

### 1.2 后端技术
| 技术 | 版本 | 用途 |
|------|------|------|
| Next.js API Routes | - | RESTful API |
| NextAuth.js | 4.24.13 | 身份认证 |
| Zod | 4.3.4 | 数据验证 |

### 1.3 AI 集成
| 技术 | 版本 | 用途 |
|------|------|------|
| Google Gemini | 3.0 Pro | AI 模型 |
| Vercel AI SDK | 6.0.49 | AI 集成工具 |

### 1.4 数据库
| 技术 | 用途 |
|------|------|
| SQLite | 开发环境 |
| PostgreSQL | 生产环境推荐 |

### 1.5 开发工具
| 工具 | 版本 | 用途 |
|------|------|------|
| ESLint | 9.x | 代码检查 |
| Vitest | 4.0.18 | 单元测试 |
| TypeScript Compiler | 5.x | 类型检查 |

---

## 2. 项目结构

```
nutricoach-pro/
├── app/                          # Next.js App Router
│   ├── (auth)/                   # 认证相关页面组
│   │   ├── login/
│   │   │   └── page.tsx         # 登录页
│   │   └── register/
│   │       └── page.tsx         # 注册页
│   ├── (dashboard)/              # 主应用页面组
│   │   ├── layout.tsx           # 仪表盘布局
│   │   ├── dashboard/
│   │   │   └── page.tsx         # 仪表盘首页
│   │   ├── clients/             # 客户管理
│   │   │   ├── page.tsx         # 客户列表
│   │   │   ├── new/
│   │   │   │   └── page.tsx     # 创建客户
│   │   │   └── [id]/
│   │   │       ├── page.tsx     # 客户详情
│   │   │       └── edit/
│   │   │           └── page.tsx # 编辑客户
│   │   ├── analysis/            # 体检报告分析
│   │   │   ├── page.tsx         # 报告列表
│   │   │   ├── new/
│   │   │   │   └── page.tsx     # 上传报告
│   │   │   └── [id]/
│   │   │       ├── page.tsx     # 报告详情
│   │   │       └── edit/
│   │   │           └── page.tsx # 编辑报告
│   │   ├── recommendations/     # 营养建议
│   │   │   ├── page.tsx         # 建议列表
│   │   │   ├── new/
│   │   │   │   └── page.tsx     # 生成建议
│   │   │   └── [id]/
│   │   │       └── page.tsx     # 建议详情
│   │   └── settings/
│   │       └── page.tsx         # 设置页
│   ├── api/                     # API 路由
│   │   ├── auth/
│   │   │   ├── [...nextauth]/
│   │   │   │   └── route.ts     # NextAuth 配置
│   │   │   └── register/
│   │   │       └── route.ts     # 用户注册
│   │   ├── clients/             # 客户 API
│   │   │   ├── route.ts         # 列表/创建
│   │   │   └── [id]/
│   │   │       ├── route.ts     # 详情/更新/删除
│   │   │       ├── diet-photos/
│   │   │       │   ├── route.ts # 照片列表/上传
│   │   │       │   └── [photoId]/
│   │   │       │       ├── route.ts # 照片详情/删除
│   │   │       │       └── analyze/
│   │   │       │           └── route.ts # AI 分析
│   │   │       └── diet-analysis/
│   │   │           └── route.ts # 饮食汇总
│   │   ├── reports/             # 报告 API
│   │   │   ├── route.ts         # 列表/创建
│   │   │   ├── [id]/
│   │   │   │   └── route.ts     # 详情/更新/删除
│   │   │   └── upload/
│   │   │       └── route.ts     # 上传分析
│   │   ├── recommendations/     # 建议 API
│   │   │   ├── route.ts         # 列表/创建
│   │   │   ├── [id]/
│   │   │   │   └── route.ts     # 详情/更新/删除
│   │   │   └── generate/
│   │   │       └── route.ts     # AI 生成
│   │   └── ai/                  # AI 服务 API
│   │       ├── analyze/
│   │       │   └── route.ts     # 分析报告
│   │       ├── analyze-image/
│   │       │   └── route.ts     # 分析图片
│   │       └── recommend/
│   │           └── route.ts     # 生成建议
│   ├── layout.tsx               # 根布局
│   ├── page.tsx                 # 首页
│   └── globals.css              # 全局样式
├── components/                  # React 组件
│   ├── layout/                  # 布局组件
│   │   ├── DashboardNavbar.tsx  # 顶部导航栏
│   │   ├── DashboardNav.tsx     # 侧边导航
│   │   └── ProtectedLayout.tsx  # 路由保护
│   ├── providers/               # Context 提供者
│   │   └── AuthProvider.tsx     # 认证上下文
│   ├── DietPhotoUpload.tsx      # 饮食照片上传
│   ├── DietPhotoCard.tsx        # 照片卡片
│   ├── DietAnalysisSummary.tsx  # 饮食汇总
│   ├── HealthConcernsInterventions.tsx
│   ├── HeartRateZones.tsx       # 心率区间
│   ├── TrafficLightGuide.tsx    # 营养信号灯
│   └── TwoWeekPlan.tsx          # 两周计划
├── lib/                         # 工具库
│   ├── ai/                      # AI 服务
│   │   ├── gemini.ts            # Gemini 集成
│   │   └── prompts.ts           # AI 提示词
│   ├── audio/                   # 音频处理
│   │   └── transcribeWithGemini.ts  # 音频转录
│   ├── auth.ts                  # 认证辅助
│   ├── auth-options.ts          # NextAuth 配置
│   └── db/                      # 数据库
│       └── prisma.ts            # Prisma 客户端
├── types/                       # TypeScript 类型
│   └── index.ts                 # 类型定义
├── prisma/                      # Prisma 配置
│   ├── schema.prisma            # 数据模型
│   └── dev.db                   # SQLite 数据库
├── tests/                       # 测试文件
│   └── api/clients/[id]/
│       ├── diet-photos.test.ts
│       ├── analyze.test.ts
│       └── diet-analysis.test.ts
├── public/                      # 静态资源
├── docs/                        # 文档
├── vitest.config.ts             # Vitest 配置
├── vitest.setup.ts              # 测试设置
├── next.config.ts               # Next.js 配置
├── tailwind.config.ts           # Tailwind 配置
├── tsconfig.json                # TypeScript 配置
└── package.json                 # 项目依赖
```

---

## 3. 数据库设计

### 3.1 数据模型关系图

```
User (用户)
  │ 1:N
  ├─→ Client (客户)
       │ 1:N
       ├─→ Report (体检报告)
       │    │ 1:N
       │    └─→ Recommendation (营养建议)
       │
       ├─→ Consultation (咨询记录)
       │    │ 1:N
       │    ├─→ audioFiles (音频文件)
       │    └─→ images (图片)
       │
       ├─→ DietPhoto (饮食照片)
       │
       └─→ Recommendation (独立建议)
```

### 3.2 表结构详解

#### User (用户表)
```prisma
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String?   // bcrypt 哈希
  role          Role      @default(NUTRITIONIST)
  clients       Client[]  // 一对多关系
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}
```

#### Client (客户表)
```prisma
model Client {
  id               String   @id @default(cuid())
  userId           String
  user             User     @relation(...)
  name             String
  gender           Gender
  birthDate        DateTime
  height           Float
  weight           Float
  activityLevel    ActivityLevel
  allergies        String   @default("[]")  // JSON: ["花生", "海鲜"]
  medicalHistory   String   @default("[]")  // JSON: ["高血压", "糖尿病"]
  healthConcerns   String   @default("[]")  // JSON: ["失眠", "肥胖"]
  preferences      String?  // 饮食偏好文本
  userRequirements String?  // 用户需求文本
  phone            String?
  email            String?

  // 饮食分析字段
  dietAnalysis     String?  // JSON 汇总
  dietPreferences  String?  // JSON 偏好
  eatingHabits     String?  // JSON 习惯

  reports          Report[]
  recommendations  Recommendation[]
  dietPhotos       DietPhoto[]
  consultations    Consultation[]
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}
```

#### Report (体检报告表)
```prisma
model Report {
  id               String   @id @default(cuid())
  clientId         String
  client           Client   @relation(...)
  fileUrl          String   // 文件存储路径
  fileName         String
  fileType         String
  extractedData    Json     // 提取的指标数据
  analysis         Json?    // AI 分析结果
  uploadedAt       DateTime @default(now())
  recommendations  Recommendation[]
}
```

#### Recommendation (营养建议表)
```prisma
model Recommendation {
  id          String   @id @default(cuid())
  clientId    String
  client      Client   @relation(...)
  reportId    String?  // 可选关联
  report      Report?  @relation(...)
  type        RecType  // DIET/EXERCISE/LIFESTYLE/COMPREHENSIVE
  content     Json     // 建议内容
  generatedAt DateTime @default(now())
}
```

#### Consultation (咨询记录表)
```prisma
model Consultation {
  id               String   @id @default(cuid())
  clientId         String
  client           Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  consultationDate DateTime @default(now())
  consultationType String   // 初次咨询/随访咨询/电话咨询/视频咨询
  sessionNotes     String?  // 咨询记录文本

  images           String?  // JSON: 存储图片Base64数组
  audioFiles       String?  // JSON: 存储音频文件信息（包含转录文本）

  analysis         String?  // ConsultationAnalysis JSON
  analyzedAt       DateTime?

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([clientId])
  @@index([consultationDate])
}
```

**AudioFiles 数据结构**:
```typescript
interface AudioFile {
  id: string;
  audioUrl: string;              // Base64
  fileName: string;
  fileSize: number;
  duration?: number;
  transcript?: string;            // 原始转录文本
  structuredTranscript?: {       // 结构化后的对话
    speaker: 'nutritionist' | 'client';
    text: string;
  }[];
  transcriptionStatus: 'pending' | 'transcribing' | 'completed' | 'failed';
  uploadedAt: Date;
}
```

#### DietPhoto (饮食照片表)
```prisma
model DietPhoto {
  id         String   @id @default(cuid())
  clientId   String
  client     Client   @relation(...)
  imageUrl   String   // Base64 图片
  uploadedAt DateTime @default(now())
  mealType   String?  // 早餐/午餐/晚餐/加餐
  notes      String?  // 备注
  analysis   String?  // JSON 分析结果
  analyzedAt DateTime?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([clientId])
}
```

### 3.3 枚举类型

```prisma
enum Role {
  ADMIN
  NUTRITIONIST
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum ActivityLevel {
  SEDENTARY      // 久坐
  LIGHT          // 轻度
  MODERATE       // 中度
  ACTIVE         // 活跃
  VERY_ACTIVE    // 非常活跃
}

enum RecType {
  DIET           // 饮食建议
  EXERCISE       // 运动建议
  LIFESTYLE      // 生活方式
  COMPREHENSIVE  // 综合建议
}
```

---

## 4. API 接口文档

### 4.1 认证接口

#### POST /api/auth/register
注册新用户

**请求体**:
```json
{
  "name": "张营养师",
  "email": "nutritionist@example.com",
  "password": "securepassword123"
}
```

**响应**: 201 Created
```json
{
  "user": {
    "id": "clxxx...",
    "name": "张营养师",
    "email": "nutritionist@example.com",
    "role": "NUTRITIONIST"
  }
}
```

#### GET /api/auth/session
获取当前会话

**响应**: 200 OK
```json
{
  "user": {
    "id": "clxxx...",
    "name": "张营养师",
    "email": "nutritionist@example.com",
    "role": "NUTRITIONIST"
  }
}
```

### 4.2 客户接口

#### GET /api/clients
获取当前用户的客户列表

**查询参数**:
- `page`: 页码（默认 1）
- `limit`: 每页数量（默认 10）

**响应**: 200 OK
```json
{
  "clients": [
    {
      "id": "clxxx...",
      "name": "张三",
      "gender": "MALE",
      "birthDate": "1990-01-01T00:00:00.000Z",
      "height": 175,
      "weight": 70,
      "activityLevel": "MODERATE",
      "createdAt": "2024-01-01T00:00:00.000Z"
    }
  ],
  "total": 25,
  "page": 1,
  "limit": 10
}
```

#### POST /api/clients
创建新客户

**请求体**:
```json
{
  "name": "张三",
  "gender": "MALE",
  "birthDate": "1990-01-01",
  "height": 175,
  "weight": 70,
  "activityLevel": "MODERATE",
  "allergies": ["花生", "海鲜"],
  "medicalHistory": ["高血压"],
  "healthConcerns": ["肥胖"],
  "preferences": "低盐低脂",
  "userRequirements": "减重",
  "phone": "13800138000",
  "email": "zhangsan@example.com"
}
```

**响应**: 201 Created
```json
{
  "client": {
    "id": "clxxx...",
    "name": "张三",
    ...
  }
}
```

#### GET /api/clients/[id]
获取客户详情

**响应**: 200 OK
```json
{
  "client": {
    "id": "clxxx...",
    "userId": "clxxx...",
    "name": "张三",
    "gender": "MALE",
    "birthDate": "1990-01-01T00:00:00.000Z",
    "height": 175,
    "weight": 70,
    "activityLevel": "MODERATE",
    "allergies": "[\"花生\",\"海鲜\"]",
    "medicalHistory": "[\"高血压\"]",
    "healthConcerns": "[\"肥胖\"]",
    "preferences": "低盐低脂",
    "userRequirements": "减重",
    "phone": "13800138000",
    "email": "zhangsan@example.com"
  }
}
```

#### PUT /api/clients/[id]
更新客户信息

**请求体**: 同 POST /api/clients

**响应**: 200 OK
```json
{
  "client": { ... }
}
```

#### DELETE /api/clients/[id]
删除客户

**响应**: 200 OK
```json
{
  "success": true,
  "message": "客户已删除"
}
```

### 4.3 饮食照片接口

#### GET /api/clients/[id]/diet-photos
获取客户的饮食照片列表

**响应**: 200 OK
```json
{
  "photos": [
    {
      "id": "photo_id",
      "clientId": "client_id",
      "imageUrl": "data:image/jpeg;base64,...",
      "mealType": "午餐",
      "notes": "家常菜",
      "analysis": {
        "mealType": "午餐",
        "overallScore": 75,
        "overallRating": "良好",
        ...
      },
      "analyzedAt": "2024-01-15T10:30:00.000Z",
      "uploadedAt": "2024-01-15T10:00:00.000Z"
    }
  ]
}
```

#### POST /api/clients/[id]/diet-photos
上传饮食照片

**请求体**:
```json
{
  "photos": [
    {
      "data": "data:image/jpeg;base64,...",
      "mealType": "午餐",
      "notes": "家常菜"
    }
  ]
}
```

**限制**:
- 单次最多 9 张照片
- 单张照片最大 5MB
- 支持 JPG、PNG 格式

**响应**: 200 OK
```json
{
  "success": true,
  "photos": [
    {
      "id": "photo_id",
      "imageUrl": "data:image/jpeg;base64,...",
      "mealType": "午餐",
      "notes": "家常菜",
      "uploadedAt": "2024-01-15T10:00:00.000Z"
    }
  ]
}
```

#### POST /api/clients/[id]/diet-photos/[photoId]/analyze
使用 AI 分析饮食照片

**响应**: 200 OK
```json
{
  "success": true,
  "analysis": {
    "mealType": "午餐",
    "description": "米饭配青菜和红烧肉",
    "foods": [
      {
        "name": "米饭",
        "category": "主食",
        "portion": "中",
        "cookingMethod": "蒸"
      },
      {
        "name": "青菜",
        "category": "蔬菜",
        "portion": "小",
        "cookingMethod": "炒"
      }
    ],
    "nutritionBalance": {
      "protein": "充足",
      "vegetables": "不足",
      "carbs": "精制",
      "fat": "混合",
      "fiber": "不足"
    },
    "issues": [
      {
        "type": "缺乏蔬菜",
        "severity": "中",
        "description": "蔬菜摄入量偏少"
      }
    ],
    "suggestions": [
      {
        "category": "增加",
        "content": "增加一份蔬菜"
      }
    ],
    "overallScore": 75,
    "overallRating": "良好"
  }
}
```

#### GET /api/clients/[id]/diet-analysis
获取客户饮食分析汇总

**响应**: 200 OK
```json
{
  "summary": {
    "totalPhotos": 10,
    "analyzedPhotos": 8,
    "overallScore": 72
  },
  "preferences": {
    "preferredFoods": ["米饭", "青菜"],
    "cookingMethods": ["炒", "蒸"],
    "mealPatterns": ["午餐", "晚餐"]
  },
  "habits": {
    "issues": ["缺乏蔬菜", "精制碳水过多"],
    "strengths": ["蛋白质摄入充足"],
    "recommendations": ["增加蔬菜摄入", "减少精制碳水"]
  }
}
```

#### DELETE /api/clients/[id]/diet-photos/[photoId]
删除饮食照片

**响应**: 200 OK
```json
{
  "success": true
}
```

### 4.4 体检报告接口

#### POST /api/reports/upload
上传并分析体检报告

**请求体**: FormData
```
file: (binary)
clientId: "client_id"
```

**响应**: 200 OK
```json
{
  "report": {
    "id": "report_id",
    "fileName": "体检报告.pdf",
    "extractedData": { ... },
    "analysis": {
      "summary": "整体健康状况...",
      "bmi": 23.5,
      "bmiCategory": "正常",
      "abnormalIndicators": [ ... ],
      "nutrientDeficiencies": [ ... ],
      "riskFactors": [ ... ],
      "overallHealthScore": 75
    }
  }
}
```

### 4.5 营养建议接口

#### POST /api/recommendations/generate
生成营养建议

**请求体**:
```json
{
  "clientId": "client_id",
  "reportId": "report_id",
  "type": "COMPREHENSIVE"
}
```

**响应**: 200 OK
```json
{
  "recommendation": {
    "id": "rec_id",
    "type": "COMPREHENSIVE",
    "content": {
      "diet": {
        "dailyCalorieTarget": 2000,
        "macroTargets": { ... },
        "foodsToEat": [ ... ],
        "foodsToAvoid": [ ... ],
        "supplements": [ ... ],
        "mealPlan": { ... }
      },
      "exercise": { ... },
      "lifestyle": { ... }
    },
    "generatedAt": "2024-01-15T10:00:00.000Z"
  }
}
```

### 4.6 咨询记录接口

#### GET /api/clients/[id]/consultations
获取客户的咨询记录列表

**查询参数**:
- `page`: 页码（默认 1）
- `limit`: 每页数量（默认 20）

**响应**: 200 OK
```json
{
  "consultations": [
    {
      "id": "consultation_id",
      "clientId": "client_id",
      "consultationDate": "2024-01-15T10:00:00.000Z",
      "consultationType": "初次咨询",
      "sessionNotes": "客户主诉...",
      "audioFiles": [
        {
          "id": "audio_id",
          "fileName": "consultation_2024-01-15.mp3",
          "fileSize": 2048576,
          "transcript": "营养师: 你好，今天感觉怎么样？...",
          "structuredTranscript": [
            { "speaker": "nutritionist", "text": "你好，今天感觉怎么样？" },
            { "speaker": "client", "text": "挺好的，最近血糖控制得不错。" }
          ],
          "transcriptionStatus": "completed",
          "uploadedAt": "2024-01-15T10:00:00.000Z"
        }
      ],
      "images": [
        {
          "id": "image_id",
          "url": "data:image/jpeg;base64,...",
          "uploadedAt": "2024-01-15T10:05:00.000Z"
        }
      ],
      "createdAt": "2024-01-15T10:00:00.000Z"
    }
  ],
  "total": 5
}
```

#### POST /api/clients/[id]/consultations
创建新的咨询记录

**请求体**:
```json
{
  "consultationType": "初次咨询",
  "sessionNotes": "咨询记录内容...",
  "audioFiles": [
    {
      "audioUrl": "data:audio/mp3;base64,...",
      "fileName": "consultation.mp3",
      "fileSize": 2048576
    }
  ],
  "images": [
    {
      "url": "data:image/jpeg;base64,...",
      "notes": "客户照片"
    }
  ]
}
```

**限制**:
- 单次最多上传 10 个音频文件
- 单个音频最大 25MB
- 支持 MP3、M4A、WAV 格式
- 单次最多上传 20 张图片

**响应**: 201 Created
```json
{
  "consultation": {
    "id": "consultation_id",
    "consultationDate": "2024-01-15T10:00:00.000Z",
    "consultationType": "初次咨询",
    "audioFiles": [
      {
        "id": "audio_id",
        "fileName": "consultation.mp3",
        "fileSize": 2048576,
        "transcriptionStatus": "pending",
        "uploadedAt": "2024-01-15T10:00:00.000Z"
      }
    ]
  }
}
```

**注意**: 音频文件上传后会自动触发异步转录任务

#### GET /api/clients/[id]/consultations/[consultationId]
获取咨询记录详情

**响应**: 200 OK
```json
{
  "consultation": {
    "id": "consultation_id",
    "clientId": "client_id",
    "consultationDate": "2024-01-15T10:00:00.000Z",
    "consultationType": "初次咨询",
    "sessionNotes": "咨询记录内容...",
    "audioFiles": [
      {
        "id": "audio_id",
        "fileName": "consultation.mp3",
        "fileSize": 2048576,
        "transcript": "营养师: 你好，今天感觉怎么样？...",
        "structuredTranscript": [
          { "speaker": "nutritionist", "text": "你好，今天感觉怎么样？" },
          { "speaker": "client", "text": "挺好的，最近血糖控制得不错。" }
        ],
        "transcriptionStatus": "completed",
        "uploadedAt": "2024-01-15T10:00:00.000Z"
      }
    ],
    "images": [...],
    "analysis": null,
    "analyzedAt": null,
    "createdAt": "2024-01-15T10:00:00.000Z",
    "updatedAt": "2024-01-15T10:30:00.000Z"
  }
}
```

#### PUT /api/clients/[id]/consultations/[consultationId]
更新咨询记录

**请求体**:
```json
{
  "sessionNotes": "更新的咨询记录",
  "consultationType": "随访咨询"
}
```

**响应**: 200 OK
```json
{
  "consultation": { ... }
}
```

#### DELETE /api/clients/[id]/consultations/[consultationId]
删除咨询记录

**响应**: 200 OK
```json
{
  "success": true,
  "message": "咨询记录已删除"
}
```

#### POST /api/clients/[id]/consultations/[consultationId]/audio/[audioId]/retranscribe
重新转录失败的音频文件

**响应**: 200 OK
```json
{
  "success": true,
  "audioFile": {
    "id": "audio_id",
    "transcriptionStatus": "transcribing"
  }
}
```

---

## 5. 核心功能实现

### 5.1 认证系统

#### NextAuth 配置
```typescript
// lib/auth-options.ts
export const authOptions: NextAuthOptions = {
  providers: [
    CredentialsProvider({
      credentials: {
        email: { label: "邮箱", type: "email" },
        password: { label: "密码", type: "password" }
      },
      async authorize(credentials) {
        // 1. 验证输入
        if (!credentials?.email || !credentials?.password) {
          throw new Error("请输入邮箱和密码");
        }

        // 2. 查找用户
        const user = await prisma.user.findUnique({
          where: { email: credentials.email }
        });

        if (!user) {
          throw new Error("用户不存在");
        }

        // 3. 验证密码
        const isValid = await bcrypt.compare(
          credentials.password,
          user.password
        );

        if (!isValid) {
          throw new Error("密码错误");
        }

        // 4. 返回用户信息
        return {
          id: user.id,
          email: user.email,
          name: user.name,
          role: user.role
        };
      }
    })
  ],
  pages: {
    signIn: '/login',
  },
  session: {
    strategy: 'jwt',
  },
  callbacks: {
    async jwt({ token, user }) {
      if (user) {
        token.role = user.role;
      }
      return token;
    },
    async session({ session, token }) {
      if (session.user) {
        session.user.id = token.sub!;
        session.user.role = token.role as string;
      }
      return session;
    }
  }
};
```

### 5.2 AI 服务集成

#### 健康报告分析
```typescript
// lib/ai/gemini.ts
export async function analyzeHealthReport(
  clientInfo: ClientInfo,
  reportData: any
): Promise<HealthAnalysis> {
  const model = google('gemini-3.0-pro');
  const prompt = HEALTH_ANALYSIS_PROMPT(clientInfo, reportData);

  const { text } = await generateText({
    model,
    prompt,
    temperature: 0.3, // 降低随机性，提高一致性
  });

  // 清理 markdown 格式
  const cleanText = text
    .replace(/```json\n?/g, '')
    .replace(/```\n?/g, '')
    .trim();

  return JSON.parse(cleanText) as HealthAnalysis;
}
```

#### 饮食照片分析 (Vision API)
```typescript
export async function analyzeDietPhoto(
  imageBase64: string,
  clientInfo: ClientInfo
): Promise<DietAnalysis> {
  const visionModel = google('gemini-3.0-pro');
  const prompt = DIET_PHOTO_ANALYSIS_PROMPT(clientInfo);

  const { text } = await generateText({
    model: visionModel,
    messages: [
      {
        role: 'user',
        content: [
          { type: 'text', text: prompt },
          { type: 'image', image: imageBase64 }
        ]
      }
    ]
  });

  const cleanText = text
    .replace(/```json\n?/g, '')
    .replace(/```\n?/g, '')
    .trim();

  return JSON.parse(cleanText) as DietAnalysis;
}
```

#### 音频转录与结构化 (Multimodal API)
```typescript
// lib/audio/transcribeWithGemini.ts
export async function transcribeAudioWithGemini(
  audioBase64: string,
  clientInfo: { name: string; age?: number }
): Promise<TranscriptionResult> {
  const apiKey = process.env.GEMINI_API_KEY;
  if (!apiKey) {
    return { success: false, error: 'Gemini API密钥未配置' };
  }

  // 清理 base64 数据
  const base64Data = audioBase64.includes(',')
    ? audioBase64.split(',')[1]
    : audioBase64;

  // 检测 MIME 类型
  let mimeType = 'audio/mp3';
  if (audioBase64.includes('data:')) {
    const match = audioBase64.match(/data:([^;]+)/);
    if (match && match[1]) mimeType = match[1];
  }

  const prompt = buildTranscriptionPrompt(clientInfo);

  // 调用 Gemini 2.5 Flash API
  const response = await fetch(
    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`,
    {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{
          parts: [
            { text: prompt },  // Prompt 必须在前
            { inline_data: { mime_type: mimeType, data: base64Data } }
          ]
        }],
        generationConfig: {
          temperature: 0.1,
          maxOutputTokens: 8192,  // 支持长音频
        },
      }),
    }
  );

  const data = await response.json();
  const responseText = data.candidates?.[0]?.content?.parts?.[0]?.text;

  // 解析结构化输出
  let structuredTranscript: Array<{ speaker: 'nutritionist' | 'client'; text: string }> | undefined;

  try {
    const jsonMatch = responseText.match(/```(?:json)?\s*([\s\S]*?)\s*```/);
    if (jsonMatch) {
      const parsed = JSON.parse(jsonMatch[1]);
      if (Array.isArray(parsed) && parsed.every(item => item.speaker && item.text)) {
        structuredTranscript = parsed;
      }
    }
  } catch (e) {
    // 使用纯文本
  }

  return {
    success: true,
    text: responseText,
    structuredTranscript,
  };
}

// 转录提示词
function buildTranscriptionPrompt(clientInfo: { name: string; age?: number }): string {
  return `你是一位专业的会议记录员和营养师助手。请完整转录以下音频。

**客户信息：**
- 姓名：${clientInfo.name}
${clientInfo.age ? `- 年龄：${clientInfo.age}岁` : ''}

**重要任务（按优先级）：**
1. **完整转录** - 请转录音频中的所有对话内容，不要遗漏
2. **识别说话人** - 区分"营养师"和"客户"（${clientInfo.name}）
3. **结构化输出** - 按说话人分段

**输出格式（纯JSON数组）：**
[
  {"speaker": "nutritionist", "text": "完整的对话内容..."},
  {"speaker": "client", "text": "完整的回答内容..."}
]`;
}
```

**转录流程**:
1. **上传阶段**: 音频转 Base64 存储，状态设为 `pending`
2. **转录阶段**: 调用 Gemini 2.5 Flash API 进行转录
3. **结构化**: AI 自动识别说话人并分段
4. **完成**: 保存原始文本和结构化对话，状态设为 `completed`

**技术要点**:
- 使用 Gemini 2.5 Flash（稳定版本，支持音频输入）
- Prompt 必须放在 audio data 之前
- `maxOutputTokens: 8192` 支持长音频
- 自动解析 JSON 格式的结构化输出

### 5.3 PDF 报告生成

```typescript
// 使用 jsPDF 生成报告
import jsPDF from 'jspdf';

export function generatePDFReport(analysis: HealthAnalysis): void {
  const doc = new jsPDF();

  // 标题
  doc.setFontSize(20);
  doc.text('健康分析报告', 20, 20);

  // 健康评分
  doc.setFontSize(14);
  doc.text(`综合评分: ${analysis.overallHealthScore}`, 20, 40);

  // 异常指标
  doc.setFontSize(12);
  let yPos = 60;
  analysis.abnormalIndicators.forEach(indicator => {
    doc.text(`${indicator.indicator}: ${indicator.value}`, 20, yPos);
    yPos += 10;
  });

  doc.save('health-report.pdf');
}
```

### 5.4 数据验证

```typescript
// 使用 Zod 验证请求数据
import { z } from 'zod';

const createClientSchema = z.object({
  name: z.string().min(1, '姓名不能为空'),
  gender: z.enum(['MALE', 'FEMALE', 'OTHER']),
  birthDate: z.string().datetime(),
  height: z.number().min(100).max(250),
  weight: z.number().min(30).max(300),
  activityLevel: z.enum(['SEDENTARY', 'LIGHT', 'MODERATE', 'ACTIVE', 'VERY_ACTIVE']),
  allergies: z.array(z.string()).default([]),
  medicalHistory: z.array(z.string()).default([]),
  healthConcerns: z.array(z.string()).default([]),
  preferences: z.string().optional(),
  userRequirements: z.string().optional(),
  phone: z.string().regex(/^1[3-9]\d{9}$/).optional(),
  email: z.string().email().optional(),
});

// 在 API 路由中使用
const validatedData = createClientSchema.parse(requestBody);
```

---

## 6. 组件设计

### 6.1 布局组件

#### DashboardNavbar (顶部导航栏)
```typescript
interface DashboardNavbarProps {
  children?: ReactNode;
}

功能:
- Logo 展示
- 导航链接
- 用户菜单
- 退出登录
```

#### ProtectedLayout (路由保护)
```typescript
功能:
- 检查用户认证状态
- 未登录重定向到登录页
- 包含完整布局
```

### 6.2 功能组件

#### DietPhotoUpload (照片上传)
```typescript
interface DietPhotoUploadProps {
  clientId: string;
  onUploadSuccess?: (photos: any[]) => void;
  maxSize?: number; // MB
}

功能:
- 拖拽上传
- 多文件选择
- 图片预览
- 餐型标注
- 备注输入
- 批量上传
```

#### DietPhotoCard (照片卡片)
```typescript
interface DietPhotoCardProps {
  id: string;
  imageUrl: string;
  mealType: string | null;
  notes: string | null;
  analysis: DietAnalysis | null;
  analyzedAt: string | null;
  uploadedAt: string;
  onDelete?: () => void;
  onAnalyze?: () => void;
  isAnalyzing?: boolean;
}

功能:
- 图片展示
- 分析结果展示
- 评分显示
- 操作按钮（分析、删除）
```

#### DietAnalysisSummary (饮食汇总)
```typescript
interface DietAnalysisSummaryProps {
  clientId: string;
}

功能:
- 综合评分
- 饮食偏好统计
- 问题汇总
- 优点汇总
- 改进建议
```

---

## 7. 状态管理

### 7.1 客户端状态

```typescript
// 使用 React Hooks 管理本地状态
const [client, setClient] = useState<Client | null>(null);
const [photos, setPhotos] = useState<DietPhoto[]>([]);
const [loading, setLoading] = useState(false);
const [error, setError] = useState<string | null>(null);
```

### 7.2 服务端状态

```typescript
// 使用 Prisma 查询数据库
const client = await prisma.client.findUnique({
  where: { id: clientId },
  include: {
    reports: true,
    recommendations: true,
    dietPhotos: true
  }
});
```

### 7.3 会话管理

```typescript
// NextAuth 会话获取
const session = await auth();

if (!session?.user) {
  return NextResponse.json({ error: '未授权' }, { status: 401 });
}

const userId = session.user.id;
```

---

## 8. 错误处理

### 8.1 API 错误处理

```typescript
try {
  // 业务逻辑
  const result = await someOperation();
  return NextResponse.json({ success: true, data: result });
} catch (error) {
  console.error('[API] Error:', error);

  if (error instanceof ZodError) {
    return NextResponse.json(
      { error: '数据验证失败', details: error.errors },
      { status: 400 }
    );
  }

  return NextResponse.json(
    { error: '服务器错误' },
    { status: 500 }
  );
}
```

### 8.2 客户端错误处理

```typescript
try {
  const response = await fetch('/api/clients');
  const data = await response.json();

  if (!response.ok) {
    throw new Error(data.error || '请求失败');
  }

  setClients(data.clients);
} catch (error) {
  console.error('Fetch error:', error);
  alert((error as Error).message);
}
```

### 8.3 AI 错误处理

```typescript
try {
  const analysis = await analyzeHealthReport(clientInfo, reportData);
  return analysis;
} catch (error) {
  console.error('AI Analysis error:', error);

  // 重试逻辑
  if (retryCount < 3) {
    await delay(1000);
    return analyzeWithRetry(clientInfo, reportData, retryCount + 1);
  }

  throw new Error('AI 分析失败，请稍后重试');
}
```

---

## 9. 性能优化

### 9.1 数据库查询优化

```typescript
// 使用索引
@@index([clientId])

// 选择性查询
const photos = await prisma.dietPhoto.findMany({
  where: {
    clientId: clientId,
    analysis: { not: null }  // 只查询已分析的照片
  },
  select: {
    id: true,
    imageUrl: true,
    analysis: true,
    // 不选择不需要的字段
  },
  orderBy: { uploadedAt: 'desc' },
  take: 20  // 限制返回数量
});
```

### 9.2 图片优化

```typescript
// 压缩 Base64 图片
function compressImage(base64: string, maxSizeKB: number = 500): string {
  const img = new Image();
  img.src = base64;

  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');

  // 计算缩放比例
  const scale = Math.min(1, Math.sqrt(maxSizeKB * 1024 / base64.length));

  canvas.width = img.width * scale;
  canvas.height = img.height * scale;

  ctx?.drawImage(img, 0, 0, canvas.width, canvas.height);
  return canvas.toDataURL('image/jpeg', 0.8);
}
```

### 9.3 缓存策略

```typescript
// 使用 React 缓存
const fetchClient = useCallback(async () => {
  const res = await fetch(`/api/clients/${clientId}`);
  return res.json();
}, [clientId]);

// 使用 SWR 或 React Query
const { data, error, isLoading } = useSWR(
  `/api/clients/${clientId}`,
  fetcher
);
```

---

## 10. 测试

### 10.1 单元测试

```typescript
// tests/api/clients/[id]/diet-photos.test.ts
import { describe, it, expect, beforeEach, vi } from 'vitest';

describe('Diet Photos API', () => {
  beforeEach(() => {
    vi.clearAllMocks();
  });

  it('应该成功上传单张照片', async () => {
    // 测试代码
  });

  it('应该拒绝超过9张照片的上传', async () => {
    // 测试代码
  });
});
```

### 10.2 测试覆盖

| 模块 | 测试文件 | 覆盖场景 |
|------|----------|----------|
| 饮食照片 API | diet-photos.test.ts | 15 个测试 |
| AI 分析 API | analyze.test.ts | 9 个测试 |
| 饮食汇总 API | diet-analysis.test.ts | 8 个测试 |

### 10.3 运行测试

```bash
# 运行所有测试
npm test

# 监听模式
npm run test:watch

# 测试 UI
npm run test:ui
```

---

## 11. 部署

### 11.1 环境变量

```bash
# .env.local
DATABASE_URL="file:./dev.db"
NEXTAUTH_SECRET="your-secret-key"
NEXTAUTH_URL="http://localhost:3000"
GEMINI_API_KEY="your-gemini-api-key"
```

### 11.2 生产部署

#### Vercel 部署
```bash
# 安装 Vercel CLI
npm i -g vercel

# 部署
vercel

# 设置环境变量
vercel env add DATABASE_URL
vercel env add NEXTAUTH_SECRET
vercel env add GEMINI_API_KEY
```

#### 自托管
```bash
# 构建项目
npm run build

# 启动生产服务器
npm start
```

### 11.3 数据库迁移

```bash
# 开发环境
npx prisma db push

# 生产环境 (PostgreSQL)
npx prisma migrate deploy

# 重置数据库（谨慎使用）
npx prisma migrate reset
```

---

## 12. 常见问题

### 12.1 开发问题

**Q: 端口 3000 被占用**
```bash
# 查找占用进程
lsof -ti:3000

# 杀死进程
kill -9 $(lsof -ti:3000)
```

**Q: 数据库连接失败**
```bash
# 重置数据库
rm -f prisma/dev.db
npx prisma db push
```

**Q: AI 分析失败**
- 检查 GEMINI_API_KEY 是否正确
- 检查 API 配额是否用尽
- 查看控制台错误日志

### 12.2 部署问题

**Q: Vercel 部署失败**
- 检查环境变量配置
- 查看 Build Log 错误信息
- 确保 Node.js 版本 >= 18.17.0

**Q: 数据库迁移失败**
```bash
# 重新生成 Prisma Client
npx prisma generate

# 重置迁移
npx prisma migrate resolve --applied "migration_name"
```

---

## 13. 开发规范

### 13.1 代码风格

```typescript
// 使用 TypeScript 严格模式
// 使用函数组件
// 使用 Hooks 管理状态
// 遵循 ESLint 规则

// 好的示例
interface Props {
  title: string;
  onSave: () => void;
}

export function Component({ title, onSave }: Props) {
  const [loading, setLoading] = useState(false);

  const handleClick = async () => {
    setLoading(true);
    try {
      await onSave();
    } finally {
      setLoading(false);
    }
  };

  return (
    <button onClick={handleClick} disabled={loading}>
      {loading ? '保存中...' : title}
    </button>
  );
}
```

### 13.2 命名规范

| 类型 | 规范 | 示例 |
|------|------|------|
| 组件 | PascalCase | `DietPhotoCard` |
| 函数 | camelCase | `analyzeDietPhoto` |
| 常量 | UPPER_SNAKE_CASE | `MAX_PHOTO_COUNT` |
| 类型 | PascalCase | `DietAnalysis` |
| 接口 | PascalCase, I 前缀 | `IClientData` |

### 13.3 注释规范

```typescript
/**
 * 分析饮食照片
 * @param imageBase64 - Base64 编码的图片
 * @param clientInfo - 客户信息
 * @returns AI 分析结果
 * @throws {Error} 当 AI 服务不可用时
 */
export async function analyzeDietPhoto(
  imageBase64: string,
  clientInfo: ClientInfo
): Promise<DietAnalysis> {
  // 实现代码
}
```

---

## 14. 版本历史

| 版本 | 日期 | 更新内容 |
|------|------|----------|
| 0.1.0 | 2024-01 | 初始版本，基础功能 |
| 0.2.0 | 2024-01 | 添加饮食照片分析 |
| 0.3.0 | 2024-01 | 添加单元测试 |

---

## 15. 技术支持

- **GitHub Issues**: [项目地址]
- **文档**: [在线文档]
- **邮箱**: support@nutricoach.pro
